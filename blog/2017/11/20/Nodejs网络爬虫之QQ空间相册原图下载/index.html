<!-- -> 定义页面布局--><!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta name="keywords" content="Mrzjd Mrzebra hexo IT font-end 前端 技术"><meta name="keywords" content="Nodejs,网络爬虫"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.bootcss.com/github-markdown-css/2.8.0/github-markdown.min.css"><link rel="stylesheet" href="/blog/less/main.css"><link rel="icon" href="/blog/images/favicon.png"><title>Nodejs网络爬虫之QQ空间相册原图下载</title><script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><script src="/blog/js/article.js"></script></head><body><header class="header"><h1 class="logo"><a href="/blog/" style="background-image:url(/blog//images/zblog-logo.png);">zblog</a></h1><i class="icon-list fa fa-bars"></i></header><div class="list-container"><ul class="header-list"><li class="header-item"><a href="/blog" title="HOME">HOME</a></li><li class="header-item"><a href="/blog/archives" title="Archives">Archives</a></li><li class="header-item"><a href="https://github.com/mrzjd" title="Github">Github</a></li></ul><div class="list-close"><i class="icon-close fa fa-times-circle-o"></i></div></div><div class="content"><article><div class="title-box"><h1 class="title"><span class="arti-tag" style="background:#003366;">网络爬虫</span>Nodejs网络爬虫之QQ空间相册原图下载</h1><div class="date"><i class="icon-calendar fa fa-calendar"></i><span class="time">2017.11.20</span></div></div><div class="article-text markdown-body"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>最近停用了QQ空间，但是想把空间里面保存的照片都导出来。找了一圈下载工具，要么有权限限制，要么下载的图片是压缩过后的图片。所以决定自己来写一个工具，顺便学习一下headless browser.</p>
<p>环境配置:</p>
<ul>
<li>headless chrome / chromium - 这一块需要翻墙下载</li>
<li>chrome canary (window下代替上一项)</li>
<li>npm pkg: puppeteer</li>
</ul>
<h2 id="1-爬取流程"><a href="#1-爬取流程" class="headerlink" title="1. 爬取流程"></a>1. 爬取流程</h2><p>先简单介绍一下流程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// a. -&gt; 启动headless chrome</span><br><span class="line">// b. -&gt; 建立页面 -&gt; 进入QQ空间登陆页面</span><br><span class="line">// c. -&gt; 登陆 -&gt; 页面跳转至QQ个人空间</span><br><span class="line">// d. -&gt; 进入QQ相册列表页</span><br><span class="line">// e. -&gt; 获取相册列表 albumlist</span><br><span class="line">// f. -&gt; 遍历列表，获取相册中的照片数据</span><br></pre></td></tr></table></figure></p>
<p>重点说明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//-&gt; 1. 关于持久化登陆</span><br><span class="line">//-&gt; 原本想登陆一次，记录下cookies。然后短期内下次进入页面不需要登陆。</span><br><span class="line">//-&gt; 可是通过cookies来记录数据没有用，转为记录storage，结果也没用。</span><br><span class="line">//-&gt; 有了解QQ web端登陆机制的可以交流一下。</span><br><span class="line"></span><br><span class="line">//-&gt; 2. 页面嵌入了iframe</span><br><span class="line">//-&gt; 登陆用了iframe, 相册数据用了iframe...腾讯这样做是为了？</span><br><span class="line"></span><br><span class="line">//-&gt; 3. album数据</span><br><span class="line">//-&gt; 从DOM中获取data-id -&gt; 对应了相册的链接中的id</span><br><span class="line"></span><br><span class="line">//-&gt; 4. photo数据</span><br><span class="line">//-&gt; 从DOM中拿到预览数据 -&gt; 根据预览数据uri转换到原图uri</span><br></pre></td></tr></table></figure></p>
<p>数据说明:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//-&gt; 登陆iframe页面</span><br><span class="line">login_url = https://xui.ptlogin2.qq.com/cgi-bin/xlogin?appid=549000912&amp;s_url=https%3A%2F%2Fqzone.qq.com</span><br><span class="line"></span><br><span class="line">//-&gt; album页面</span><br><span class="line">albums_url = https://user.qzone.qq.com/&#123;qq_id&#125;/photo</span><br><span class="line">album_url = https://user.qzone.qq.com/&#123;qq_id&#125;/photo/&#123;album_id&#125;</span><br><span class="line"></span><br><span class="line">//-&gt; photo img</span><br><span class="line">//获取到预览图片的img.src</span><br><span class="line">//改变src中的hostname -&gt; 对应到原图host: &apos;http://r.photo.store.qq.com/psb&apos;</span><br><span class="line">//-&gt; 有部分年代比较久远或者原图本来就很小的 -&gt; host: &apos;http://b221.photo.store.qq.com&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="puppeteer相关接口"><a href="#puppeteer相关接口" class="headerlink" title="puppeteer相关接口"></a>puppeteer相关接口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// -&gt; 启动</span><br><span class="line">var browser = await puppeteer.launch(&#123;</span><br><span class="line">    executablePath: config.executablePath</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// -&gt; 页面</span><br><span class="line">var page = await browser.newPage();</span><br><span class="line"></span><br><span class="line">// -&gt; 页面操作</span><br><span class="line">// page.goto(uri);</span><br><span class="line">// page.waitForFunction(filter); //-&gt; 页面进行等待 -&gt; 知道filter返回true; 用于等待页面的加载跳转等</span><br><span class="line">// page.$()/$$(); //-&gt; 获取domHandler -&gt; 注意这里不是获取原生DOM, 而是封装过后处理器</span><br><span class="line">// page.evaluateHandle(fn); //-&gt; 将fn放入page环境中执行 //-&gt; 用于返回window/document等处理对象</span><br><span class="line">// page.evaluate(fn, args); //-&gt; 同上 //-&gt; 用于返回一下非DOM/BOM的数据对象(如获取DOMAttribute)</span><br><span class="line"></span><br><span class="line">// -&gt; 元素操作</span><br><span class="line">// element.type();/click();</span><br><span class="line"></span><br><span class="line">// 更多参考文档</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这算得上是第一次利用async/await语法写一个实战应用。总体感觉相对于promise来说，编码体验好很多。不需要一个一个then方法的执行。少了很多不必要的代码。但是利用async/await在调试错误处理方面的体验却不是很好，异常直接抛出。可以使用try/catch来捕获异常，但是代码结构上面又变得不是特别优雅了。这一块可能需要再深入学习一下相关资料，看是否有最佳实践。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/26810049" target="_blank" rel="noopener">知乎 - 使用 Headless Chrome 进行页面渲染</a></li>
<li><p><a href="https://zhuanlan.zhihu.com/p/30203613" target="_blank" rel="noopener">知乎 - 无头浏览器Puppeteer初探</a></p>
</li>
<li><p><a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="noopener">Chrome Debugging Protocol</a></p>
</li>
<li><a href="https://github.com/cyrus-and/chrome-remote-interface" target="_blank" rel="noopener">Github - chrome-remote-interface</a></li>
<li><a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">Github - Puppeteer</a></li>
</ul>
</div></article></div><footer class="footer"><p class="info">Welcome to mrzjd's blog!</p><div class="infobox"><ul class="contacts"><li class="contacts-i">QQ: 390303304</li><li class="contacts-i">Mail: 390303304@qq.com</li></ul><p>Powered by hexo and github. The theme is zebra-theme.</p></div></footer></body></html>